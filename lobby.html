<!-- lobby.html (replace file content with this) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SpaceGo — Lobby</title>
  <style>
    html, body { height:100%; margin:0; background:#0b0d10; color:#e9eef5; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { min-height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:24px; box-sizing:border-box; gap:12px; }
    .card { width: min(920px, 100%); border:1px solid #202733; background:#0f1318; border-radius:16px; padding:16px; box-sizing:border-box; }
    h1 { font-size:18px; margin:0 0 8px; font-weight:650; }
    h2 { font-size:13px; margin:14px 0 8px; font-weight:650; opacity:0.95; }
    .muted { opacity:0.8; font-size:12px; }
    input, select, button, a.btn {
      background:#0b0d10; color:#e9eef5;
      border:1px solid #2a3443; border-radius:10px;
      padding:10px 12px; font-size:14px;
      text-decoration:none;
      display:inline-flex; align-items:center; justify-content:center;
      box-sizing:border-box;
    }
    button, a.btn { background:#1a2230; cursor:pointer; }
    button:hover, a.btn:hover { background:#222c3d; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin:10px 0; }
    .spacer { flex:1; }
    .status { font-size:12px; opacity:0.85; }
    .danger { color:#ffb4b4; }
    .ok { color:#b9ffcc; }

    .list {
      margin-top: 10px;
      border: 1px solid #202733;
      border-radius: 14px;
      overflow: hidden;
      background: #0b0d10;
    }
    .listHeader {
      display:flex;
      gap:10px;
      padding:10px 12px;
      border-bottom: 1px solid #202733;
      font-size: 12px;
      opacity: 0.85;
      user-select:none;
      align-items: center;
    }
    .listHeader > div { flex: 1; }
    .listHeader .colMoves { flex: 0 0 84px; }
    .listHeader .colPhase { flex: 0 0 82px; }
    .listHeader .colWhen { flex: 0 0 140px; text-align:right; }

    #create.isDisabled { opacity: 0.55; }

    .gameRow {
      display:flex;
      gap:10px;
      padding:12px;
      border-bottom: 1px solid #141a22;
      cursor: pointer;
      align-items: center;
      min-width: 0;
    }
    .gameRow:last-child { border-bottom:none; }
    .gameRow:hover { background:#0f1318; }
    .gameRow > div { flex: 1; min-width: 0; }

    .gameRow .colMoves { flex: 0 0 84px; opacity: 0.9; }
    .gameRow .colPhase { flex: 0 0 82px; opacity: 0.9; text-transform: lowercase; }
    .gameRow .colWhen { flex: 0 0 140px; text-align:right; opacity: 0.75; font-size: 12px; }

    .nameCell { font-weight: 650; display:flex; align-items:center; gap:8px; min-width: 0; }
    .nameCell > span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    .tag {
      display:inline-flex;
      align-items:center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #2a3443;
      background: #0b0d10;
      font-size: 11px;
      opacity: 0.95;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .tag.turn { border-color: #3c5a7a; }
    .tag.seat { border-color: #2f4b38; }
    .gameRow.yourTurn { background: #101a26; }
    .gameRow.yourTurn:hover { background: #122035; }

    .createRow { flex-wrap: wrap; }
    .createRow .nameLabel { flex: 0 0 auto; }
    .createRow #name { flex: 1 1 260px; min-width: 220px; }
    .createRow .bsGroup { display:inline-flex; align-items:center; gap:10px; white-space: nowrap; flex: 0 0 auto; }
    .createRow #create { flex: 0 0 auto; }

    .emptyRow {
      padding: 12px;
      opacity: 0.75;
      font-size: 12px;
    }
	
	.siteTitle{
  font-size:26px;
  font-weight:750;
  letter-spacing:0.2px;
  line-height:1;
  color:#e9eef5;
  user-select:none;
  white-space:nowrap;
}
@media (max-width:700px){
  .siteTitle{ font-size:20px; }
}

    .footerBar {
      width: min(920px, 100%);
      border: 1px solid #202733;
      background: #0f1318;
      border-radius: 16px;
      padding: 10px 12px;
      box-sizing: border-box;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .footerBar .left { display:flex; gap:10px; align-items:center; min-width:0; }
    .footerBar .right { display:flex; gap:10px; align-items:center; }
    .footerHint { opacity: 0.7; font-size: 12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    @media (max-width: 700px) {
      .wrap { padding: 12px; }

      /* Only show: name + updated */
      .listHeader .colMoves,
      .listHeader .colPhase { display: none; }

      .gameRow .colMoves,
      .gameRow .colPhase { display: none; }

      .gameRow { flex-wrap: nowrap; gap: 10px; }
      .gameRow > div { min-width: 0; }

      .gameRow .colWhen {
        flex: 0 0 140px;
        text-align: right;
      }

      .footerBar { border-radius: 14px; }
      .footerHint { display:none; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="footerBar">
      <div class="left">
        <div class="siteTitle">SpaceGo</div>
      </div>
      <div class="right">
        <a class="btn" href="/about">About</a>
        <a class="btn" href="/donate">Support</a>
      </div>
    </div>
    <div class="card">
	

      <div style="border:1px solid #333; padding:10px; margin:10px 0;">
        <div>
          <input id="authEmail" type="email" placeholder="email" />
          <input id="authPass" type="password" placeholder="password" />
        </div>
        <div style="margin-top:8px;">
          <button id="authLogin">Login</button>
          <button id="authSignup">Sign up</button>
          <button id="authLogout">Logout</button>
          <span id="authStatus" style="margin-left:10px;"></span>
        </div>
      </div>

      <script type="module">
        import { wireAuthUI } from "./auth_client.js";

        wireAuthUI({
          emailEl: document.getElementById("authEmail"),
          passEl: document.getElementById("authPass"),
          statusEl: document.getElementById("authStatus"),
          btnLogin: document.getElementById("authLogin"),
          btnSignup: document.getElementById("authSignup"),
          btnLogout: document.getElementById("authLogout"),
        });
      </script>

      <h1>Lobby</h1>
      <div class="muted">Create a game (named), or click an existing game to open it.</div>

      <div class="row" style="margin-top:14px;">
        <button id="refresh">Refresh</button>
        <div class="spacer"></div>
        <div class="status" id="status"></div>
      </div>

      <h2>Your seated games</h2>
      <div class="muted" id="myHint" style="margin-top:-2px;"></div>
      <div class="list" id="myList">
        <div class="listHeader">
          <div>name</div>
          <div class="colMoves">moves</div>
          <div class="colPhase">phase</div>
          <div class="colWhen">updated</div>
        </div>
        <div id="myGameList"></div>
      </div>

      <h2 style="margin-top:16px;">All games</h2>
      <div class="list" id="list">
        <div class="listHeader">
          <div>name</div>
          <div class="colMoves">moves</div>
          <div class="colPhase">phase</div>
          <div class="colWhen">updated</div>
        </div>
        <div id="gameList"></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="prevPage">Prev</button>
        <button id="nextPage">Next</button>
        <div class="spacer"></div>
        <div class="status" id="pageInfo"></div>
      </div>

      <div class="row createRow" style="margin-top:14px;">
        <div class="muted nameLabel">Create new:</div>
        <input id="name" type="text" placeholder="game name" style="width: 260px" />
        <span class="bsGroup">
          <span class="muted">Board Size:</span>
          <select id="size" style="width: 120px"></select>
          <button id="create">Create</button>
        </span>
      </div>
      <div id="createWarn" style="display:none; margin-top:6px; font-size:12px; color:#b00020;">
        You must enter a game name and a game size
      </div>

    </div>

    
  </div>

<script>
  const elList = document.getElementById('gameList');
  const elMyList = document.getElementById('myGameList');
  const elStatus = document.getElementById('status');
  const elMyHint = document.getElementById('myHint');

  const btnPrev = document.getElementById('prevPage');
  const btnNext = document.getElementById('nextPage');
  const elPageInfo = document.getElementById('pageInfo');

  let pageCursor = 0;
  const pageLimit = 50;

  function setStatus(msg, kind) {
    elStatus.textContent = msg || '';
    elStatus.className = 'status ' + (kind || '');
  }

  function clampInt(v, lo, hi, fallback) {
    const n = Number(v);
    if (!Number.isFinite(n)) return fallback;
    const t = Math.trunc(n);
    return Math.max(lo, Math.min(hi, t));
  }

  function ago(ms) {
    if (!ms) return '';
    const d = Date.now() - ms;
    const s = Math.max(0, Math.floor(d / 1000));
    if (s < 10) return 'just now';
    if (s < 60) return s + 's ago';
    const m = Math.floor(s / 60);
    if (m < 60) return m + 'm ago';
    const h = Math.floor(m / 60);
    if (h < 48) return h + 'h ago';
    const days = Math.floor(h / 24);
    return days + 'd ago';
  }

  async function apiGet(path) {
    const r = await fetch(path, { method:'GET' });
    let data = null;
    try { data = await r.json(); } catch (_) {}
    if (!r.ok) throw new Error((data && (data.error || data.reason)) || ('HTTP ' + r.status));
    return data;
  }

  async function apiPost(path, body) {
    const r = await fetch(path, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(body || {})
    });
    let data = null;
    try { data = await r.json(); } catch (_) {}
    if (!r.ok) throw new Error((data && (data.error || data.reason)) || ('HTTP ' + r.status));
    return data;
  }

  function goGame(gameId) {
    if (!gameId) return;
    window.location.href = `/game.html?gameId=${encodeURIComponent(gameId)}`;
  }

  function clearEl(el) {
    while (el.firstChild) el.removeChild(el.firstChild);
  }

  function seatLabel(side) {
    if (side === 1) return 'Seated: Black';
    if (side === 2) return 'Seated: White';
    return '';
  }

  function addEmpty(el, text) {
    const empty = document.createElement('div');
    empty.className = 'emptyRow';
    empty.textContent = text;
    el.appendChild(empty);
  }

  function addRow(g, targetEl) {
    const row = document.createElement('div');
    row.className = 'gameRow';
    if (g.yourTurn) row.classList.add('yourTurn');
    row.addEventListener('click', () => goGame(g.gameId));

    const cName = document.createElement('div');
    const nameTop = document.createElement('div');
    nameTop.className = 'nameCell';

    const nameText = document.createElement('span');
    nameText.textContent = (g.name || '(unnamed)');
    nameTop.appendChild(nameText);

    if (g.yourTurn) {
      const t = document.createElement('span');
      t.className = 'tag turn';
      t.textContent = 'Your turn';
      nameTop.appendChild(t);
    }

    if (g.youSide === 1 || g.youSide === 2) {
      const t2 = document.createElement('span');
      t2.className = 'tag seat';
      t2.textContent = seatLabel(g.youSide);
      nameTop.appendChild(t2);
    }

    cName.appendChild(nameTop);

    const cMoves = document.createElement('div');
    cMoves.className = 'colMoves';
    cMoves.textContent = String(g.moveCount ?? 0);

    const cPhase = document.createElement('div');
    cPhase.className = 'colPhase';
    cPhase.textContent = (g.phase || 'play');

    const cWhen = document.createElement('div');
    cWhen.className = 'colWhen';
    cWhen.textContent = ago(g.updatedAt);

    row.appendChild(cName);
    row.appendChild(cMoves);
    row.appendChild(cPhase);
    row.appendChild(cWhen);

    targetEl.appendChild(row);
  }

  function sortGames(games) {
    return [...games].sort((a, b) => {
      const at = a.yourTurn ? 1 : 0;
      const bt = b.yourTurn ? 1 : 0;
      if (bt !== at) return bt - at;
      return (b.updatedAt || 0) - (a.updatedAt || 0);
    });
  }

  function fillAll(games) {
    clearEl(elList);
    if (!games.length) return addEmpty(elList, 'No games yet');
    const sorted = sortGames(games);
    for (const g of sorted) addRow(g, elList);
  }

  function fillMine(games, authed) {
    clearEl(elMyList);

    if (!authed) {
      elMyHint.textContent = 'Sign in to see your seated games.';
      addEmpty(elMyList, 'Signed out');
      return;
    }

    const mine = sortGames(games.filter(g => g.youSide === 1 || g.youSide === 2));
    elMyHint.textContent = mine.length ? '' : 'None yet.';
    if (!mine.length) return addEmpty(elMyList, 'No seated games');
    for (const g of mine) addRow(g, elMyList);
  }

  async function refresh() {
    setStatus('Loading…');
    try {
      const who = await apiGet('/api/whoami');

      const mineResp = await apiGet(`/api/games?scope=mine&limit=200`);
      const allResp = await apiGet(`/api/games?scope=all&cursor=${pageCursor}&limit=${pageLimit}`);

      fillMine(mineResp.games || [], !!who.authed);
      fillAll(allResp.games || []);

      const total = allResp.total || 0;
      const start = total ? (allResp.cursor + 1) : 0;
      const end = allResp.cursor + (allResp.games ? allResp.games.length : 0);

      elPageInfo.textContent = total ? `Showing ${start}-${end} of ${total}` : '';
      btnPrev.disabled = (allResp.cursor || 0) <= 0;
      btnNext.disabled = !allResp.hasMore;

      setStatus((allResp.games || []).length ? `Loaded ${end} / ${total}` : 'No games yet', (allResp.games || []).length ? 'ok' : '');
    } catch (e) {
      setStatus(e.message || 'Failed', 'danger');
    }
  }

  document.getElementById('refresh').addEventListener('click', () => {
    pageCursor = 0;
    refresh();
  });

  btnPrev?.addEventListener('click', () => {
    pageCursor = Math.max(0, pageCursor - pageLimit);
    refresh();
  });

  btnNext?.addEventListener('click', () => {
    pageCursor = pageCursor + pageLimit;
    refresh();
  });

  const elName = document.getElementById('name');
  const elSize = document.getElementById('size');
  const btnCreate = document.getElementById('create');
  const elCreateWarn = document.getElementById('createWarn');

  function showCreateWarn(show) {
    if (!elCreateWarn) return;
    elCreateWarn.style.display = show ? 'block' : 'none';
  }

  function computeCreateInputs() {
    const name = (elName.value || '').trim();
    const sizeRaw = elSize.value;

    const nameOk = name.length > 0;
    const sizeOk = !!sizeRaw;

    const N = sizeOk ? clampInt(sizeRaw, 5, 30, 13) : null;

    btnCreate.classList.toggle('isDisabled', !(nameOk && sizeOk));
    btnCreate.setAttribute('aria-disabled', (nameOk && sizeOk) ? 'false' : 'true');

    if (nameOk && sizeOk) showCreateWarn(false);

    return { name, N, nameOk, sizeOk };
  }

  elName.addEventListener('input', computeCreateInputs);
  elSize.addEventListener('change', computeCreateInputs);

  document.getElementById('create').addEventListener('click', async () => {
    const { name, N, nameOk, sizeOk } = computeCreateInputs();

    if (!nameOk || !sizeOk) {
      showCreateWarn(true);
      if (!nameOk) { setStatus('Enter a game name', 'danger'); elName.focus(); }
      else { setStatus('Select a board size', 'danger'); elSize.focus(); }
      return;
    }

    showCreateWarn(false);

    setStatus('Creating…');
    try {
      const out = await apiPost('/api/game/new', { N, name });
      if (!out || !out.gameId) throw new Error('Bad response');
      setStatus('Created', 'ok');
      goGame(out.gameId);
    } catch (e) {
      setStatus(e.message || 'Failed', 'danger');
    }
  });

  (function initBoardSizeSelect() {
    const sel = document.getElementById('size');
    if (!sel || sel.tagName !== 'SELECT') return;

    sel.innerHTML = '';

    const ph = document.createElement('option');
    ph.value = '';
    ph.textContent = 'Select size…';
    ph.disabled = true;
    ph.selected = true;
    sel.appendChild(ph);

    for (let n = 5; n <= 30; n++) {
      const opt = document.createElement('option');
      opt.value = String(n);
      opt.textContent = String(n);
      sel.appendChild(opt);
    }
  })();

  computeCreateInputs();
  refresh();
</script>
</body>
</html>
